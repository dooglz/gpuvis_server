<!DOCTYPE html>
<html>

<head>
  <title>AJAX Upload Example</title>
  <script src="msgpack.min.js"></script>
  <script src="jquery-3.3.1.min.js"></script>
  <script type="text/javascript">
    function updateProgress(evt) {
      if (evt.lengthComputable) {
        $("#output").text("Uploaded " + evt.loaded + " of " + evt.total + " bytes");
      }
    }
    var result_data;
    var decoded_data;
    function uploadFile() {

      var file_data = new FormData(document.getElementById('filename'));
      $.ajax({
        url: "http://localhost/upload",
        type: "POST",
        data: file_data,
        processData: false,
        contentType: false,
        cache: false,
        xhrFields: {
          responseType: 'blob'
        },
        xhr: function () {
          myXhr = $.ajaxSettings.xhr();
          if (myXhr.upload) {
            myXhr.upload.addEventListener('progress', updateProgress, false); // for handling the progress of the upload
          }
          return myXhr;
        },
      }).done(function (data) {
        result_data = data;
        var reader = new FileReader();
        reader.addEventListener("loadend", function () {
          decoded_data = msgpack.decode(new Uint8Array(reader.result));
          $("#output").html("Decoded Result! " + decoded_data.rET.length + " Register Events!<br>" + JSON.stringify(decoded_data).substr(0,1024));
        });
        reader.readAsArrayBuffer(result_data);
        $("#output").html("Recieved Result: " + result_data.size );
      });
      return false;
    }
  </script>
</head>

<body>
  <h1>Manual file Upload</h1>
  <form method="post" id="filename" name="filename" onsubmit="return uploadFile();">
    <label>Select a file:</label><br>
    <input type="file" id="file" name="inputfile" required />
    <input type="submit" value="Upload" />
  </form>
  <br><hr><br>
  <div id="output"></div>
</body>

</html>